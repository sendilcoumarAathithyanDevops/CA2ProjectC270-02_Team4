name: CD Pipeline

on:
  push:
    branches: [ main ]
  workflow_run:
    workflows: [ "CI/CD Pipeline" ]
    types: [ completed ]
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Log in to Container Registry
      uses: docker/login-action@v2
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v4
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=sha,prefix={{branch}}-
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=raw,value=latest,enable={{is_default_branch}}
    
    - name: Build and push Docker image
      id: build
      uses: docker/build-push-action@v4
      with:
        context: .
        file: ./docker/Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Image digest
      run: echo "Image digest: ${{ steps.build.outputs.digest }}"

  deploy-staging:
    needs: build-and-push
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: http://localhost:3000
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Deploy with Docker Compose (Staging)
      run: |
        docker-compose -f docker/docker-compose.yml up -d
        echo "Waiting for services to be healthy..."
        sleep 5
    
    - name: Run smoke tests
      run: |
        echo "Running smoke tests..."
        curl -f http://localhost:3000/ || exit 1
        echo "✓ Server is responding"
    
    - name: Check Docker containers
      run: |
        echo "Checking container status..."
        docker-compose -f docker/docker-compose.yml ps
    
    - name: Run integration tests
      run: |
        npm ci
        npm test -- --testPathPattern=server.test.js
      continue-on-error: true

  security-scan-image:
    needs: build-and-push
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Log in to Container Registry
      uses: docker/login-action@v2
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Run Trivy vulnerability scanner on image
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ needs.build-and-push.outputs.image-tag }}
        format: 'sarif'
        output: 'trivy-image-results.sarif'
        severity: 'CRITICAL,HIGH'
    
    - name: Upload Trivy results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-image-results.sarif'
        category: 'trivy-image'

  performance-check:
    needs: deploy-staging
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Performance health check
      run: |
        echo "Running performance checks..."
        for i in {1..10}; do
          RESPONSE_TIME=$(curl -w "%{time_total}" -o /dev/null -s http://localhost:3000/)
          echo "Request $i - Response time: ${RESPONSE_TIME}s"
          if (( $(echo "$RESPONSE_TIME > 2" | bc -l) )); then
            echo "⚠ Response time exceeds 2 seconds"
          fi
        done
        echo "✓ Performance checks completed"
    
    - name: Check memory and disk
      run: |
        docker stats --no-stream angry-birds-game || true

  notify-deployment:
    needs: [ build-and-push, deploy-staging, security-scan-image ]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Deployment Summary
      run: |
        echo "=== Deployment Summary ==="
        echo "Build Status: ${{ needs.build-and-push.result }}"
        echo "Staging Deployment Status: ${{ needs.deploy-staging.result }}"
        echo "Security Scan Status: ${{ needs.security-scan-image.result }}"
        echo "Image Tag: ${{ needs.build-and-push.outputs.image-tag }}"
        echo "Image Digest: ${{ needs.build-and-push.outputs.image-digest }}"
    
    - name: Create deployment annotation
      run: |
        echo "Deployment completed on $(date)"
        echo "GitHub SHA: ${{ github.sha }}"
        echo "GitHub Ref: ${{ github.ref }}"

  rollback-on-failure:
    needs: [ deploy-staging, security-scan-image, performance-check ]
    runs-on: ubuntu-latest
    if: failure()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Rollback deployment
      run: |
        echo "Rolling back deployment..."
        docker-compose -f docker/docker-compose.yml down
        echo "✓ Rollback completed"
    
    - name: Send failure notification
      run: |
        echo "⚠ Deployment failed and has been rolled back"
        echo "Check the logs above for details"
